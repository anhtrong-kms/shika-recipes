let recipes = [];
let preparedIndex = new Map(); // Map t√™n chu·∫©n h√≥a -> object m√≥n Prepared

/* ===== N·∫°p d·ªØ li·ªáu ===== */
async function fetchData() {
  const response = await fetch("recipes.json");
  recipes = await response.json();

  // L·∫≠p ch·ªâ m·ª•c cho nh√≥m Prepared ƒë·ªÉ tra c·ª©u nhanh
  preparedIndex = new Map(
    recipes
      .filter(r => r.category === "Prepared")
      .map(r => [normalizeName(r.tenMon), r])
  );

  renderDefault();
}
fetchData();

/* ===== Ph·∫ßn t·ª≠ DOM ===== */
const menuSection = document.getElementById("menu-section");
const searchInput = document.getElementById("search");
const ingredientInput = document.getElementById("search-ingredient");

const panel = document.getElementById("recipe-panel");
const overlay = document.getElementById("modal-overlay");
const closeBtn = document.getElementById("close-panel");

const prepMini = document.getElementById("prep-mini");
const prepMiniClose = document.getElementById("prep-mini-close");
const prepMiniTitle = document.getElementById("prep-mini-title");
const prepMiniIngredients = document.getElementById("prep-mini-ingredients");
const prepMiniStepsTitle = document.getElementById("prep-mini-steps-title");
const prepMiniSteps = document.getElementById("prep-mini-steps");

/* ===== Utils ===== */
function normalizeName(s) {
  return (s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/\p{Diacritic}/gu, "") // b·ªè d·∫•u ti·∫øng Vi·ªát
    .replace(/\s+/g, " ")
    .trim();
}

/**
 * T√¨m c√°c "nguy√™n li·ªáu th√†nh ph·∫©m" xu·∫•t hi·ªán trong danh s√°ch nguyenLieu c·ªßa m√≥n.
 * So kh·ªõp substring kh√¥ng d·∫•u/kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng.
 */
function findPreparedRefsOfRecipe(recipe) {
  const results = [];
  const ingredients = recipe?.nguyenLieu || [];
  const preparedNames = Array.from(preparedIndex.keys()); // normalized

  for (const line of ingredients) {
    const normLine = normalizeName(line);
    for (const pName of preparedNames) {
      if (normLine.includes(pName)) {
        const obj = preparedIndex.get(pName);
        if (obj && !results.some(x => x.tenMon === obj.tenMon)) {
          results.push(obj);
        }
      }
    }
  }
  return results;
}

/* ===== Render helpers ===== */

/** Card c√≥ ·∫£nh cho menu th∆∞·ªùng */
function renderCardsNormal(list) {
  menuSection.style.display = "grid";
  menuSection.innerHTML = "";

  list.forEach((item) => {
    const card = document.createElement("div");
    card.className = "menu-card";
    const imgSrc = item.hinhAnh || "images/placeholder.png";
    card.innerHTML = `
      <img src="${imgSrc}" alt="${item.tenMon}">
      <h3>${item.tenMon}</h3>
    `;
    card.addEventListener("click", () => showRecipe(item));
    menuSection.appendChild(card);
  });
}

/** Card ch·ªâ c√≥ t√™n (kh√¥ng h√¨nh) cho nh√≥m Prepared */
function renderCardsPrepared(list) {
  menuSection.style.display = "grid";
  menuSection.innerHTML = "";

  list.forEach((item) => {
    const card = document.createElement("div");
    card.className = "menu-card prepared-card";
    card.innerHTML = `<h3>üÜÇ ${item.tenMon}</h3>`;
    card.addEventListener("click", () => showRecipe(item));
    menuSection.appendChild(card);
  });
}

/** Router: n·∫øu to√†n b·ªô l√† Prepared -> card t√™n; ng∆∞·ª£c l·∫°i -> card th∆∞·ªùng */
function renderRecipes(list) {
  if (list.length > 0 && list.every(x => x.category === "Prepared")) {
    renderCardsPrepared(list);
  } else {
    renderCardsNormal(list);
  }
}

/** M·∫∑c ƒë·ªãnh = tab "T·∫•t c·∫£" nh∆∞ng lo·∫°i tr·ª´ Prepared */
function renderDefault() {
  const list = recipes.filter(r => r.category !== "Prepared");
  renderCardsNormal(list);
}

/* ===== Pop-up l·ªõn ===== */

function showRecipe(item) {
  // Ti√™u ƒë·ªÅ, size
  document.getElementById("panel-title").textContent = item.tenMon || "";
  document.getElementById("panel-size").textContent = item.dungLuong || "";

  // ·∫¢nh (·∫©n n·∫øu Prepared)
  const img = document.getElementById("panel-img-src");
  if (item.category === "Prepared") {
    panel.classList.add("is-prepared");
    img.src = "";
    img.alt = "";
  } else {
    panel.classList.remove("is-prepared");
    img.src = item.hinhAnh || "";
    img.alt = item.tenMon || "";
  }

  // Nguy√™n li·ªáu
  const ingredientsList = document.getElementById("panel-ingredients");
  ingredientsList.innerHTML = "";
  (item.nguyenLieu || []).forEach((ing) => {
    const li = document.createElement("li");
    li.textContent = ing;
    ingredientsList.appendChild(li);
  });

  // Chips "Xem c√°ch l√†m" cho c√°c Prepared c√≥ trong c√¥ng th·ª©c (ch·ªâ xu·∫•t hi·ªán v·ªõi m√≥n th∆∞·ªùng)
  const refList = document.getElementById("prepared-ref-list");
  refList.innerHTML = "";
  if (item.category !== "Prepared") {
    const refs = findPreparedRefsOfRecipe(item);
    if (refs.length > 0) {
      refs.forEach(ref => {
        const chip = document.createElement("button");
        chip.className = "prepared-ref-chip";
        chip.type = "button";
        chip.textContent = `Xem c√°ch l√†m: ${ref.tenMon}`;
        chip.addEventListener("click", (e) => {
          e.stopPropagation();
          openPreparedMini(ref);
        });
        refList.appendChild(chip);
      });
    }
  }

  // C√¥ng th·ª©c (·∫©n n·∫øu kh√¥ng c√≥ step h·ª£p l·ªá)
  const stepsTitle = document.getElementById("steps-title");
  const stepsList = document.getElementById("panel-steps");
  stepsList.innerHTML = "";

  const steps = (item.congThuc || []).filter(s => {
    const t = (s || "").trim().toLowerCase();
    return t && !t.includes("ch∆∞a c√≥ c√¥ng th·ª©c");
  });

  if (steps.length === 0) {
    stepsTitle.style.display = "none";
    stepsList.style.display = "none";
  } else {
    stepsTitle.style.display = "";
    stepsList.style.display = "";
    steps.forEach((step) => {
      const li = document.createElement("li");
      li.textContent = step;
      stepsList.appendChild(li);
    });
  }

  openPanel();
}

function openPanel() {
  panel.classList.add("active");
  overlay.classList.add("active");
  overlay.setAttribute("aria-hidden", "false");
  document.body.classList.add("modal-open");

  // Tr√°nh nh·∫£y viewport tr√™n mobile
  const isCoarse = window.matchMedia("(pointer: coarse)").matches;
  if (!isCoarse) panel.focus();
}

function closePanel() {
  panel.classList.remove("active");
  overlay.classList.remove("active");
  overlay.setAttribute("aria-hidden", "true");
  document.body.classList.remove("modal-open");
  closePreparedMini(); // ƒë√≥ng mini n·∫øu ƒëang m·ªü
}

closeBtn.addEventListener("click", closePanel);
overlay.addEventListener("click", () => {
  // N·∫øu mini ƒëang m·ªü, click overlay ƒë√≥ng c·∫£ 2
  if (prepMini.classList.contains("active")) closePreparedMini();
  closePanel();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    if (prepMini.classList.contains("active")) { closePreparedMini(); return; }
    closePanel();
  }
});

/* ===== Mini pop-up: ƒë·ªãnh v·ªã c·∫°nh ph·∫£i c·ªßa popup l·ªõn ===== */

function positionPreparedMiniRight() {
  // N·∫øu mini kh√¥ng m·ªü -> b·ªè qua
  if (!prepMini.classList.contains("active")) return;

  const panelRect = panel.getBoundingClientRect();
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  // K√≠ch th∆∞·ªõc mong mu·ªën
  const miniWidth = Math.min(420, Math.floor(vw * 0.42));
  const miniHeight = Math.min(prepMini.offsetHeight || 400, Math.floor(vh * 0.8));
  const gap = 12; // kho·∫£ng c√°ch gi·ªØa 2 popup

  // V·ªã tr√≠ ƒë·ªÅ xu·∫•t: d√≠nh c·∫°nh ph·∫£i panel
  let left = Math.round(panelRect.right + gap);
  let top = Math.round(panelRect.top);

  // N·∫øu tr√†n ph·∫£i -> th·ª≠ d√≠nh c·∫°nh tr√°i c·ªßa panel
  if (left + miniWidth > vw) {
    left = Math.round(panelRect.left - gap - miniWidth);
  }

  // N·∫øu v·∫´n kh√¥ng ƒë·∫∑t ƒë∆∞·ª£c (m√†n qu√° h·∫πp ho·∫∑c panel full-screen) -> fallback center
  const cannotPlaceSide = (left < 0) || (panelRect.width >= vw - 40);
  if (cannotPlaceSide) {
    prepMini.classList.remove("side");
    // reset ƒë·ªÉ d√πng transform center m·∫∑c ƒë·ªãnh
    prepMini.style.left = "";
    prepMini.style.top = "";
    prepMini.style.width = "";
    prepMini.style.maxHeight = "";
    return;
  }

  // Clamp theo chi·ªÅu d·ªçc ƒë·ªÉ kh√¥ng tr√†n
  const maxTop = Math.max(0, vh - miniHeight - 10);
  top = Math.min(Math.max(10, top), maxTop);

  // √Åp to·∫° ƒë·ªô & k√≠ch th∆∞·ªõc
  prepMini.classList.add("side");
  prepMini.style.position = "fixed";
  prepMini.style.left = left + "px";
  prepMini.style.top = top + "px";
  prepMini.style.width = miniWidth + "px";
  prepMini.style.maxHeight = Math.min(vh - top - 10, Math.floor(vh * 0.8)) + "px";
}

/* ===== MINI POP-UP (Nguy√™n li·ªáu th√†nh ph·∫©m: Nguy√™n li·ªáu + C√¥ng th·ª©c) ===== */

function openPreparedMini(prepItem) {
  // Ti√™u ƒë·ªÅ
  prepMiniTitle.textContent = prepItem.tenMon || "Nguy√™n li·ªáu th√†nh ph·∫©m";

  // Nguy√™n li·ªáu
  prepMiniIngredients.innerHTML = "";
  (prepItem.nguyenLieu || []).forEach(ing => {
    const li = document.createElement("li");
    li.textContent = ing;
    prepMiniIngredients.appendChild(li);
  });

  // C√¥ng th·ª©c (l·ªçc b·ªè d√≤ng r·ªóng / "ch∆∞a c√≥ c√¥ng th·ª©c")
  prepMiniSteps.innerHTML = "";
  const steps = (prepItem.congThuc || []).filter(s => {
    const t = (s || "").trim().toLowerCase();
    return t && !t.includes("ch∆∞a c√≥ c√¥ng th·ª©c");
  });

  if (steps.length === 0) {
    prepMiniStepsTitle.style.display = "none";
    prepMiniSteps.style.display = "none";
  } else {
    prepMiniStepsTitle.style.display = "";
    prepMiniSteps.style.display = "";
    steps.forEach(step => {
      const li = document.createElement("li");
      li.textContent = step;
      prepMiniSteps.appendChild(li);
    });
  }

  // M·ªü mini
  prepMini.classList.add("active");
  prepMini.setAttribute("aria-hidden", "false");

  // ƒê·ªãnh v·ªã c·∫°nh ph·∫£i c·ªßa panel v√† g·∫Øn listener
  positionPreparedMiniRight();
  const _reposition = () => positionPreparedMiniRight();
  window.addEventListener("resize", _reposition);
  window.addEventListener("scroll", _reposition, { passive: true });
  prepMini._reposition = _reposition;
}

function closePreparedMini() {
  // Th√°o listener v√† reset style
  if (prepMini._reposition) {
    window.removeEventListener("resize", prepMini._reposition);
    window.removeEventListener("scroll", prepMini._reposition);
    prepMini._reposition = null;
  }
  prepMini.classList.remove("side");
  prepMini.style.left = "";
  prepMini.style.top = "";
  prepMini.style.width = "";
  prepMini.style.maxHeight = "";

  prepMini.classList.remove("active");
  prepMini.setAttribute("aria-hidden", "true");
}
prepMiniClose.addEventListener("click", closePreparedMini);

/* ===== Search & Filters (theo tab ƒëang m·ªü) ===== */
function getActiveCategory() {
  const activeBtn = document.querySelector(".filter-btn.active");
  return activeBtn?.dataset.category || "all";
}
function getBaseListByActiveTab() {
  const cat = getActiveCategory();
  if (cat === "all") return recipes.filter(r => r.category !== "Prepared");
  return recipes.filter(r => r.category === cat);
}

searchInput.addEventListener("input", () => {
  const keyword = searchInput.value.trim().toLowerCase();
  const base = getBaseListByActiveTab();
  const filtered = base.filter(r => (r.tenMon || "").toLowerCase().includes(keyword));
  renderRecipes(filtered);
});

ingredientInput.addEventListener("input", () => {
  const keyword = ingredientInput.value.trim().toLowerCase();
  const base = getBaseListByActiveTab();
  const filtered = base.filter(r =>
    (r.nguyenLieu || []).some(i => (i || "").toLowerCase().includes(keyword))
  );
  renderRecipes(filtered);
});

document.querySelectorAll(".filter-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const cat = btn.dataset.category || "all";
    let filtered;
    if (cat === "all") {
      filtered = recipes.filter(r => r.category !== "Prepared");
    } else {
      filtered = recipes.filter(r => r.category === cat);
    }
    renderRecipes(filtered);

    // Reset √¥ t√¨m ki·∫øm khi ƒë·ªïi tab
    searchInput.value = "";
    ingredientInput.value = "";
  });
});
